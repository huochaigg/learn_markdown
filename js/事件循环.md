
JavaScript çš„ **äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰** æ˜¯å…¶å¼‚æ­¥ç¼–ç¨‹çš„æ ¸å¿ƒæœºåˆ¶ï¼Œå®ƒä½¿å¾— JS èƒ½åœ¨å•çº¿ç¨‹ä¸ŠåŒæ—¶å¤„ç†å¼‚æ­¥ä»»åŠ¡ï¼ˆæ¯”å¦‚å®šæ—¶å™¨ã€ç½‘ç»œè¯·æ±‚ã€DOM äº‹ä»¶ç­‰ï¼‰ã€‚

JavaScript åªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šæ‰§è¡Œä»»åŠ¡ï¼Œå³ä¸€æ¬¡åªèƒ½åšä¸€ä»¶äº‹ã€‚ä¸ºäº†å¤„ç†**å¼‚æ­¥ä»»åŠ¡**è€Œä¸é˜»å¡ä¸»çº¿ç¨‹ï¼Œæµè§ˆå™¨ï¼ˆæˆ– Node.jsï¼‰ä½¿ç”¨äº† **äº‹ä»¶å¾ªç¯æœºåˆ¶**ã€‚

JS è¿è¡Œç¯å¢ƒä¸­é€šå¸¸åŒ…å«ä»¥ä¸‹å‡ ä¸ªå…³é”®ç»„æˆï¼š

### 1. è°ƒç”¨æ ˆï¼ˆCall Stackï¼‰

- å­˜æ”¾æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°ã€‚
    
- åè¿›å…ˆå‡ºï¼ˆLIFOï¼‰ç»“æ„ã€‚
    

### 2. å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMicrotask Queueï¼‰

- ä¼˜å…ˆçº§é«˜ã€‚
    
- åŒ…æ‹¬ï¼š
    
    - `Promise.then/catch/finally`
        
    - `queueMicrotask`
        
    - `MutationObserver`
        

### 3. å®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMacrotask Queueï¼‰

- ä¼˜å…ˆçº§ä½äºå¾®ä»»åŠ¡ã€‚
    
- åŒ…æ‹¬ï¼š
    
    - `setTimeout`
        
    - `setInterval`
        
    - `setImmediate`ï¼ˆNodeï¼‰
        
    - `MessageChannel`
        
    - DOM äº‹ä»¶
        
    - ç½‘ç»œè¯·æ±‚çš„å›è°ƒ


äº‹ä»¶å¾ªç¯çš„åŸºæœ¬è¿‡ç¨‹ï¼š

```
1. æ‰§è¡Œå…¨å±€åŒæ­¥ä»£ç ï¼ˆå‹å…¥è°ƒç”¨æ ˆï¼‰
2. æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆMicrotaskï¼‰
3. æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼ˆMacrotaskï¼‰
4. æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—
5. é‡å¤æ­¥éª¤ 3 å’Œ 4
```

æ¯æ¬¡å®ä»»åŠ¡ä¹‹é—´ï¼Œ**ä¸€å®šä¼šæ¸…ç©ºæ‰€æœ‰çš„å¾®ä»»åŠ¡**ã€‚


## ä¸¾ä¾‹ï¼š

```
console.log('start');

setTimeout(() => {
  console.log('setTimeout');
}, 0);

Promise.resolve().then(() => {
  console.log('promise1');
}).then(() => {
  console.log('promise2');
});

console.log('end');
```

- **åŒæ­¥ä»£ç **å…ˆæ‰§è¡Œï¼Œè¾“å‡ºï¼š`start`ã€`end`
    
- **å¾®ä»»åŠ¡é˜Ÿåˆ—**ï¼š`promise1` -> `promise2`
    
- **å®ä»»åŠ¡é˜Ÿåˆ—**ï¼š`setTimeout`

è¾“å‡ºï¼š

```
start
end
promise1
promise2
setTimeout
```


### ä¾‹2ï¼š

```
console.log('1');
setTimeout(() => console.log('2'), 0);
Promise.resolve().then(() => console.log('3'));
queueMicrotask(() => console.log('4'));
console.log('5');
```

è¾“å‡ºï¼š

```
1
5
3
4
2
```


æ³¨æ„ï¼šå’Œnodejsä¸­çš„äº‹ä»¶å¾ªç¯æœ‰åŒºåˆ«


### å¤æ‚ä¾‹å­ï¼š

```
console.log('ğŸ§© åŒæ­¥ 1');

setTimeout(() => {
  console.log('â° setTimeout 1');

  Promise.resolve().then(() => {
    console.log('ğŸŒ€ promise in setTimeout 1');
  });

  queueMicrotask(() => {
    console.log('ğŸŒ€ microtask in setTimeout 1');
  });
}, 0);

Promise.resolve().then(() => {
  console.log('ğŸŒ€ promise 1');

  setTimeout(() => {
    console.log('â° setTimeout 2');

    queueMicrotask(() => {
      console.log('ğŸŒ€ microtask in setTimeout 2');
    });

    Promise.resolve().then(() => {
      console.log('ğŸŒ€ promise in setTimeout 2');
    });
  }, 0);
});

queueMicrotask(() => {
  console.log('ğŸŒ€ microtask 1');

  Promise.resolve().then(() => {
    console.log('ğŸŒ€ nested promise in microtask');
  });
});

setTimeout(() => {
  console.log('â° setTimeout 3');
}, 0);

console.log('ğŸ§© åŒæ­¥ 2');

```

è¾“å‡ºï¼š

```
ğŸ§© åŒæ­¥ 1
ğŸ§© åŒæ­¥ 2
ğŸŒ€ promise 1
ğŸŒ€ microtask 1
ğŸŒ€ nested promise in microtask
â° setTimeout 1
ğŸŒ€ promise in setTimeout 1
ğŸŒ€ microtask in setTimeout 1
â° setTimeout 2
ğŸŒ€ microtask in setTimeout 2
ğŸŒ€ promise in setTimeout 2
â° setTimeout 3
```