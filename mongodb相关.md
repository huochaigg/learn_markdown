# mongodb ç›¸å…³
## å®‰è£…
```
brew tap mongodb/brew
brew install mongodb-community@5.0
```

## å¯åŠ¨
```
brew services start mongodb/brew/mongodb-community
```

## mongodbå†™å…¥å®‰å…¨çº§åˆ«
https://www.cnblogs.com/phpfans/p/4852808.html


## ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„ MongoDB æ•°æ®åº“æ“ä½œæŒ‡ä»¤ã€‚è¿™äº›æŒ‡ä»¤å¯ä»¥é€šè¿‡ MongoDB Shell æˆ–å‘½ä»¤è¡Œå·¥å…·è¿›è¡Œæ“ä½œã€‚

### 1. åˆ›å»º/åˆ‡æ¢æ•°æ®åº“
åœ¨ MongoDB ä¸­ï¼Œæ•°æ®åº“ä¼šåœ¨æ’å…¥æ•°æ®æ—¶è‡ªåŠ¨åˆ›å»ºï¼Œå¦‚æœæ•°æ®åº“ä¸å­˜åœ¨ã€‚ä½¿ç”¨ use å‘½ä»¤åˆ‡æ¢åˆ°ä¸€ä¸ªæ•°æ®åº“ï¼Œè‹¥è¯¥æ•°æ®åº“ä¸å­˜åœ¨ï¼Œåˆ™ä¼šåˆ›å»ºå®ƒã€‚

```
use mydatabase
```

### 2. æŸ¥çœ‹å½“å‰æ•°æ®åº“
æŸ¥çœ‹å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“ã€‚
```
db
```

### 3. æŸ¥çœ‹æ‰€æœ‰æ•°æ®åº“
æŸ¥çœ‹ MongoDB ä¸­çš„æ‰€æœ‰æ•°æ®åº“ã€‚
```
show databases
```

### 4. åˆ›å»º/åˆ‡æ¢é›†åˆ
ä½¿ç”¨ **`db.createCollection()`** æ˜¾å¼åˆ›å»ºä¸€ä¸ªé›†åˆã€‚å¦‚æœé›†åˆå·²ç»å­˜åœ¨ï¼Œåˆ™ä¸ä¼šé‡æ–°åˆ›å»ºã€‚
```
db.createCollection("users")
```
æˆ–è€…ï¼Œç›´æ¥æ’å…¥æ–‡æ¡£æ—¶ï¼ŒMongoDB ä¼šè‡ªåŠ¨åˆ›å»ºé›†åˆã€‚
```
db.users.insertOne({ name: "Alice", age: 25 })
```
### 5. æŸ¥çœ‹å½“å‰æ•°æ®åº“çš„æ‰€æœ‰é›†åˆ
æŸ¥çœ‹å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰é›†åˆã€‚
```
show collections
```
### 6. æ’å…¥æ–‡æ¡£
æ’å…¥ä¸€ä¸ªæ–‡æ¡£ï¼š
```
db.users.insertOne({ name: "Alice", age: 25 })
```
æ’å…¥å¤šä¸ªæ–‡æ¡£ï¼š
```
db.users.insertMany([
  { name: "Bob", age: 30 },
  { name: "Charlie", age: 35 }
])
```
### 7. æŸ¥è¯¢æ–‡æ¡£
æŸ¥è¯¢æ‰€æœ‰æ–‡æ¡£ï¼š
```
db.users.find()
```
æŸ¥è¯¢ç‰¹å®šæ¡ä»¶çš„æ–‡æ¡£ï¼š
```
db.users.find({ age: { $gt: 30 } })
```
æŸ¥è¯¢ç‰¹å®šå­—æ®µï¼š
```
db.users.find({ name: "Alice" }, { age: 1 })
```
é™åˆ¶æŸ¥è¯¢ç»“æœçš„æ•°é‡ï¼š
```
db.users.find().limit(5)
```
### 8. æ›´æ–°æ–‡æ¡£
æ›´æ–°ä¸€ä¸ªæ–‡æ¡£ï¼š
```
db.users.updateOne(
  { name: "Alice" },
  { $set: { age: 26 } }
)
```
æ›´æ–°å¤šä¸ªæ–‡æ¡£ï¼š
```
db.users.updateMany(
  { age: { $lt: 30 } },
  { $set: { status: "young" } }
)
```
#### å¸¸è§æ“ä½œç¬¦ï¼š
#### **1.ä¿®æ”¹å­—æ®µå€¼**
#### $setï¼šè®¾ç½®å­—æ®µçš„å€¼ï¼ˆå¦‚æœå­—æ®µä¸å­˜åœ¨ï¼Œåˆ™æ–°å¢ï¼‰
```
db.users.updateOne({ name: "Alice" }, { $set: { age: 26 } })
```
#### $unsetï¼šåˆ é™¤å­—æ®µ
```
db.users.updateOne({ name: "Alice" }, { $unset: { age: "" } })
```
#### $renameï¼šé‡å‘½åå­—æ®µ
```
db.users.updateOne({ name: "Alice" }, { $rename: { "age": "years_old" } })
```
#### **2. æ•°å€¼è¿ç®—**
#### $incï¼šé€’å¢æˆ–é€’å‡æ•°å€¼å­—æ®µ
```
db.users.updateOne({ name: "Alice" }, { $inc: { age: 1 } })  // age +1
```
```
db.users.updateOne({ name: "Alice" }, { $inc: { age: -1 } }) // age -1
```
#### $mulï¼šæŒ‰å€æ•°å¢åŠ æ•°å€¼
```
db.users.updateOne({ name: "Alice" }, { $mul: { salary: 1.1 } }) // å·¥èµ„å¢åŠ  10%
```
#### $minï¼šåªæœ‰å½“æ–°å€¼å°äºå½“å‰å€¼æ—¶æ‰æ›´æ–°
ç®€ç§°è‡³å¤šä¸º
```
db.users.updateOne({ name: "Alice" }, { $min: { age: 18 } })
```
#### $maxï¼šåªæœ‰å½“æ–°å€¼å¤§äºå½“å‰å€¼æ—¶æ‰æ›´æ–°
ç®€ç§°è‡³å°‘ä¸º
```
db.users.updateOne({ name: "Alice" }, { $max: { age: 30 } })
```
**ç¤ºä¾‹ 1ï¼šæ›´æ–° age ä½†ä»…åœ¨æ–°å€¼æ›´å°æ—¶**
```
db.users.updateOne(
  { name: "Alice" },
  { $min: { age: 20 } }
)
```
**è§£é‡Š**
* å¦‚æœ Alice çš„ age ç›®å‰æ˜¯ 25ï¼Œåˆ™ age ä¼šæ›´æ–°ä¸º 20ï¼ˆå› ä¸º 20 å°äº 25ï¼‰ã€‚
* å¦‚æœ Alice çš„ age ç›®å‰æ˜¯ 18ï¼Œåˆ™ age ä¿æŒ 18ï¼ˆå› ä¸º 20 å¤§äº 18ï¼Œä¸æ›´æ–°ï¼‰ã€‚

**ç¤ºä¾‹ 2ï¼šä»…å½“ price é™ä½æ—¶æ›´æ–°**
```
db.products.updateOne(
  { product: "Laptop" },
  { $min: { price: 800 } }
)
```
**è§£é‡Š**

* å¦‚æœ Laptop çš„ price ç›®å‰æ˜¯ 1000ï¼Œåˆ™æ›´æ–°ä¸º 800ï¼ˆå› ä¸º 800 < 1000ï¼‰ã€‚
* å¦‚æœ Laptop çš„ price ç›®å‰æ˜¯ 750ï¼Œåˆ™ä¿æŒä¸å˜ï¼ˆå› ä¸º 800 > 750ï¼‰ã€‚


#### **3. æ•°ç»„æ“ä½œ**
#### $pushï¼šå‘æ•°ç»„æ·»åŠ ä¸€ä¸ªå…ƒç´ 
```
db.users.updateOne({ name: "Alice" }, { $push: { hobbies: "swimming" } })
```
#### $addToSetï¼šå‘æ•°ç»„æ·»åŠ ä¸€ä¸ªå”¯ä¸€å€¼ï¼ˆå¦‚æœè¯¥å€¼å·²å­˜åœ¨ï¼Œåˆ™ä¸ä¼šæ·»åŠ ï¼‰
```
db.users.updateOne({ name: "Alice" }, { $addToSet: { hobbies: "reading" } })
```
#### $popï¼šä»æ•°ç»„çš„ å¼€å¤´ï¼ˆ-1ï¼‰æˆ–ç»“å°¾ï¼ˆ1ï¼‰ åˆ é™¤ä¸€ä¸ªå…ƒç´ 
```
db.users.updateOne({ name: "Alice" }, { $pop: { hobbies: -1 } }) // åˆ é™¤ç¬¬ä¸€ä¸ªå…ƒç´ 
```
```
db.users.updateOne({ name: "Alice" }, { $pop: { hobbies: 1 } })  // åˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ 
```
#### $pullï¼šä»æ•°ç»„ä¸­åˆ é™¤æŒ‡å®šå…ƒç´ 
```
db.users.updateOne({ name: "Alice" }, { $pull: { hobbies: "swimming" } })
```
#### $pullAllï¼šä»æ•°ç»„ä¸­åˆ é™¤å¤šä¸ªæŒ‡å®šå…ƒç´ 
```
db.users.updateOne({ name: "Alice" }, { $pullAll: { hobbies: ["swimming", "reading"] } })
```
#### **4. å­—æ®µåˆå¹¶**
#### $currentDateï¼šå°†å­—æ®µå€¼è®¾ç½®ä¸ºå½“å‰æ—¥æœŸ/æ—¶é—´
```
db.users.updateOne({ name: "Alice" }, { $currentDate: { lastUpdated: true } })
```
#### $bitï¼šå¯¹æ•°å€¼å­—æ®µæ‰§è¡ŒæŒ‰ä½è¿ç®—
```
db.users.updateOne({ name: "Alice" }, { $bit: { age: { and: 5 } } }) // æŒ‰ä½ä¸
```
#### **5. æ¡ä»¶æ›´æ–°**
#### $setOnInsertï¼šä»…åœ¨ æ’å…¥ï¼ˆæ–‡æ¡£ä¸å­˜åœ¨æ—¶ï¼‰æ—¶è®¾ç½®å­—æ®µï¼ˆé€šå¸¸ä¸ upsert: true ä¸€èµ·ä½¿ç”¨ï¼‰
```
db.users.updateOne(
  { name: "Alice" },
  { $setOnInsert: { age: 25, city: "New York" } },
  { upsert: true }
)
```
#### $condï¼ˆåœ¨ update è¯­å¥ä¸­ä½¿ç”¨ $set æ­é… $condï¼‰
```
db.users.updateOne(
  { name: "Alice" },
  { $set: { age: { $cond: { if: { $gte: ["$age", 30] }, then: 30, else: "$age" } } } }
)
```
##### **âœ… `$cond` çš„ä¸¤ç§è¯­æ³•**

`$cond` åœ¨ MongoDB ä¸­æœ‰ **ä¸¤ç§å†™æ³•**ï¼š

1.  **å¯¹è±¡è¯­æ³•ï¼ˆæ ‡å‡†å†™æ³•ï¼‰**ï¼š
    
    ```
    {
      $cond: {
        if: <æ¡ä»¶>,
        then: <trueæ—¶çš„å€¼>,
        else: <falseæ—¶çš„å€¼>
      }
    }
    ```
    
    âœ… **é€‚ç”¨äºæ¸…æ™°çš„ `if-then-else` é€»è¾‘**
    
2.  **æ•°ç»„è¯­æ³•ï¼ˆç®€å†™ï¼‰**ï¼š
    
    ```
    { $cond: [ <æ¡ä»¶>, <trueæ—¶çš„å€¼>, <falseæ—¶çš„å€¼> ] }
    ```
    
    âœ… **é€‚ç”¨äºæ›´ç®€æ´çš„è¡¨è¾¾**
    

* * *

##### **ğŸš€ è§£æä½ çš„ `$cond` è¯­æ³•**

ä½ çš„ `aggregate` è¯­å¥ï¼š

```markdown
db.orders.aggregate([
  {
    $addFields: {
      discountedPrice: {
        $expr: {
          $cond: [
            { $gt: ["$discount", 0.2] },
            { $multiply: ["$price", { $subtract: [1, "$discount"] }] },
            "$price"
          ]
        }
      }
    }
  }
]);
```

##### **ğŸ”¥ è¿™é‡Œçš„ `$cond` ç”¨çš„æ˜¯** **æ•°ç»„è¯­æ³•**ï¼š

```markdown
$cond: [
  æ¡ä»¶,       // $gt: ["$discount", 0.2]  --> å¦‚æœ discount > 0.2
  çœŸå€¼,       // $multiply: ["$price", { $subtract: [1, "$discount"] }]  --> è®¡ç®—æŠ˜æ‰£ä»·
  å‡å€¼        // "$price"  --> å¦åˆ™ï¼Œä»·æ ¼ä¸å˜
]
```

ç­‰ä»·äºï¼š

```markdown
$cond: {
  if: { $gt: ["$discount", 0.2] },
  then: { $multiply: ["$price", { $subtract: [1, "$discount"] }] },
  else: "$price"
}
```

**ğŸ’¡ ç”±äº `$cond` è¯­æ³•å…è®¸ä½¿ç”¨æ•°ç»„çš„æ–¹å¼è¡¨è¾¾ `if-then-else`ï¼Œæ‰€ä»¥æ²¡æœ‰ `if, then, else` å…³é”®å­—ï¼Œä½†é€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚**

* * *

##### **ğŸš€ ä»€ä¹ˆæ—¶å€™ç”¨å¯¹è±¡è¯­æ³•ï¼Œä»€ä¹ˆæ—¶å€™ç”¨æ•°ç»„è¯­æ³•ï¼Ÿ**

| **è¯­æ³•** | **é€‚ç”¨åœºæ™¯** | **ä¼˜ç‚¹** | **ç¼ºç‚¹** |
| --- | --- | --- | --- |
| **å¯¹è±¡è¯­æ³• `{ if, then, else }`** | **é€»è¾‘æ¸…æ™°ã€å¯è¯»æ€§å¼º** | é€‚åˆå¤æ‚ `if-then-else` ç»“æ„ | ä»£ç ç¨é•¿ |
| **æ•°ç»„è¯­æ³• `[ æ¡ä»¶, çœŸå€¼, å‡å€¼ ]`** | **è¡¨è¾¾å¼ç®€å•æ—¶ï¼Œä»£ç æ›´çŸ­** | ä»£ç æ›´ç´§å‡‘ | å¯èƒ½å¯è¯»æ€§è¾ƒå·® |

ğŸ“Œ **å¦‚æœ `if-else` é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®ç”¨å¯¹è±¡è¯­æ³•ï¼ˆæ¸…æ™°ï¼‰ã€‚** ğŸ“Œ **å¦‚æœ `if-else` é€»è¾‘å¾ˆç®€å•ï¼Œæ•°ç»„è¯­æ³•æ›´ç®€æ´ã€‚**

* * *

##### **ğŸš€ å†æ¥ä¸€ä¸ªç¤ºä¾‹**

å‡è®¾ä½ æœ‰ä¸€ä¸ª `students` é›†åˆï¼Œå­—æ®µå¦‚ä¸‹ï¼š

```markdown
[
  { "_id": 1, "name": "Alice", "score": 85 },
  { "_id": 2, "name": "Bob", "score": 40 },
  { "_id": 3, "name": "Charlie", "score": 75 }
]
```

å¦‚æœ **åˆ†æ•° â‰¥ 60**ï¼Œåˆ™æ ‡è®° `"Pass"`ï¼Œå¦åˆ™æ ‡è®° `"Fail"`ã€‚

##### **âœ… ç”¨å¯¹è±¡è¯­æ³•**

```markdown
db.students.aggregate([
  {
    $project: {
      name: 1,
      score: 1,
      result: {
        $cond: {
          if: { $gte: ["$score", 60] },
          then: "Pass",
          else: "Fail"
        }
      }
    }
  }
]);
```

##### **âœ… ç”¨æ•°ç»„è¯­æ³•**

```markdown
db.students.aggregate([
  {
    $project: {
      name: 1,
      score: 1,
      result: { $cond: [ { $gte: ["$score", 60] }, "Pass", "Fail" ] }
    }
  }
]);
```
è¿™ä¸ªæ“ä½œçš„æ„æ€æ˜¯ï¼šå¦‚æœ age å¤§äºç­‰äº 30ï¼Œåˆ™å°†å…¶è®¾ä¸º 30ï¼Œå¦åˆ™ä¿æŒä¸å˜ã€‚
æ€»ç»“
| æ“ä½œç¬¦ | ä½œç”¨ |
|---|---|
| $set | è®¾ç½®æˆ–æ–°å¢å­—æ®µ |
| $unset | åˆ é™¤å­—æ®µ |
| $rename | é‡å‘½åå­—æ®µ |
| $inc | é€’å¢/é€’å‡æ•°å€¼ |
| $mul | æŒ‰å€æ•°å¢åŠ æ•°å€¼ |
| $min/$max | ä»…åœ¨æ–°å€¼æ›´å°æ—¶/æ›´å¤§æ—¶æ›´æ–° |
| $push | å‘æ•°ç»„æ·»åŠ å…ƒç´  |
| $addToSet | å‘æ•°ç»„æ·»åŠ å”¯ä¸€å€¼ |
| $pop | ä»æ•°ç»„çš„å¼€å¤´/ç»“å°¾åˆ é™¤å…ƒç´  |
| $pull | ä»æ•°ç»„ä¸­åˆ é™¤æŒ‡å®šå…ƒç´  |
| $pullAll | ä»æ•°ç»„ä¸­åˆ é™¤å¤šä¸ªæŒ‡å®šå…ƒç´  |
| $currentDate | è®¾ç½®å½“å‰æ—¶é—´ |
| $bit | æŒ‰ä½è¿ç®— |
| $setOnInsert | ä»…åœ¨æ’å…¥æ–‡æ¡£æ—¶è®¾ç½®å­—æ®µï¼ˆé€‚ç”¨äº upsert: trueï¼‰ |

è¿™äº›æ“ä½œç¬¦å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œä»¥æ»¡è¶³å¤æ‚çš„æ›´æ–°éœ€æ±‚ã€‚ä½ å¯ä»¥æ ¹æ®è‡ªå·±çš„å…·ä½“ä¸šåŠ¡é€»è¾‘é€‰æ‹©åˆé€‚çš„æ›´æ–°æ–¹å¼ã€‚

### 9. åˆ é™¤æ–‡æ¡£
åˆ é™¤ä¸€ä¸ªæ–‡æ¡£ï¼š
```
db.users.deleteOne({ name: "Alice" })
```
åˆ é™¤å¤šä¸ªæ–‡æ¡£ï¼š
```
db.users.deleteMany({ age: { $gt: 30 } })
```
### 10. èšåˆæŸ¥è¯¢ (Aggregation)
ä½¿ç”¨èšåˆè¿›è¡Œå¤æ‚çš„æŸ¥è¯¢å’Œå¤„ç†ï¼š
```
db.users.aggregate([
  { $match: { age: { $gt: 20 } } },
  { $group: { _id: "$age", total: { $sum: 1 } } }
])
```

#### **å¸¸è§çš„èšåˆæ“ä½œé˜¶æ®µ**
#### $match
ç”¨äºç­›é€‰æ–‡æ¡£ï¼Œç±»ä¼¼äº find æ“ä½œç¬¦ï¼Œä½†å®ƒæ˜¯åœ¨ç®¡é“ä¸­çš„ä¸€ä¸ªé˜¶æ®µã€‚é€šå¸¸åœ¨ç®¡é“çš„å¼€å¤´ä½¿ç”¨ï¼Œä»¥å‡å°‘æ•°æ®é‡ã€‚
```
db.collection.aggregate([
  { $match: { status: 'active' } }
]);
```
#### $group
æŒ‰ç…§æŒ‡å®šçš„å­—æ®µåˆ†ç»„ï¼Œå¹¶å¯ä»¥å¯¹æ¯ç»„æ•°æ®è¿›è¡Œèšåˆæ“ä½œï¼Œå¦‚æ±‚å’Œã€å¹³å‡æ•°ã€æœ€å¤§å€¼ã€æœ€å°å€¼ç­‰ã€‚
```
db.collection.aggregate([
  { $group: { _id: "$category", total: { $sum: "$amount" } } }
]);
```
#### $project
ç”¨äºé‡å¡‘æ–‡æ¡£ï¼Œé€‰æ‹©ã€æ’é™¤æˆ–è®¡ç®—æ–°çš„å­—æ®µã€‚å®ƒå¸¸ç”¨äºä¿®æ”¹è¾“å‡ºæ ¼å¼æˆ–ç”Ÿæˆæ–°çš„è®¡ç®—å­—æ®µã€‚
```
db.collection.aggregate([
  { $project: { name: 1, age: 1, yearOfBirth: { $subtract: [2025, "$age"] } } }
]);
```
#### $sort
ç”¨äºå¯¹ç»“æœè¿›è¡Œæ’åºï¼Œç±»ä¼¼äº find().sort()ã€‚æ’åºæŒ‰æŒ‡å®šå­—æ®µå‡åºæˆ–é™åºæ’åˆ—ã€‚
```
db.collection.aggregate([
  { $sort: { age: -1 } }  // æŒ‰å¹´é¾„é™åº
]);
```
#### $limit
é™åˆ¶è¿”å›çš„æ–‡æ¡£æ•°é‡ï¼Œç±»ä¼¼äº find().limit()ã€‚
```
db.collection.aggregate([
  { $limit: 5 }
]);
```
#### $skip
è·³è¿‡æŒ‡å®šæ•°é‡çš„æ–‡æ¡£ï¼Œé€šå¸¸ä¸ $limit ä¸€èµ·ä½¿ç”¨è¿›è¡Œåˆ†é¡µã€‚
```
db.collection.aggregate([
  { $skip: 10 },
  { $limit: 5 }
]);
```
#### $unwind
ç”¨äºâ€œå±•å¼€â€æ•°ç»„å­—æ®µï¼Œå°†æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ å±•å¼€æˆç‹¬ç«‹çš„æ–‡æ¡£ï¼Œé€šå¸¸ç”¨äºå¤„ç†æ•°ç»„å­—æ®µã€‚
```
db.collection.aggregate([
  { $unwind: "$items" }
]);
```
#### $lookup
ç”¨äºè¿›è¡Œé›†åˆä¹‹é—´çš„è”æ¥ï¼ˆç±»ä¼¼ SQL çš„ JOIN æ“ä½œï¼‰ã€‚å¯ä»¥ä»å¦ä¸€ä¸ªé›†åˆä¸­å¼•å…¥ç›¸å…³æ–‡æ¡£ã€‚
```
db.orders.aggregate([
  { $lookup: {
      from: "products",
      localField: "productId",
      foreignField: "_id",
      as: "productDetails"
    }
  }
]);
```
#### $addFields
å‘æ–‡æ¡£ä¸­æ·»åŠ æˆ–ä¿®æ”¹å­—æ®µï¼Œæˆ–è€…ä½¿ç”¨ç°æœ‰å­—æ®µè®¡ç®—æ–°å­—æ®µã€‚
```
db.collection.aggregate([
  { $addFields: { totalAmount: { $multiply: ["$quantity", "$price"] } } }
]);
```
#### $count
ç”¨äºè®¡ç®—æ–‡æ¡£çš„æ•°é‡ï¼Œå¹¶å°†ç»“æœä»¥æ–‡æ¡£å½¢å¼è¿”å›ï¼Œå­—æ®µåé»˜è®¤ä¸º countã€‚
```
db.collection.aggregate([
  { $match: { status: "active" } },
  { $count: "activeUsers" }
]);
```
**èšåˆç®¡é“ä¾‹å­**
å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªè®¢å•é›†åˆï¼Œæ¯ä¸ªæ–‡æ¡£åŒ…å«è®¢å•çš„è¯¦ç»†ä¿¡æ¯ã€‚æˆ‘ä»¬å¸Œæœ›è®¡ç®—æ¯ä¸ªå®¢æˆ·çš„æ€»è´­ä¹°é‡‘é¢ï¼Œå¹¶æ’åºã€‚
```
db.orders.aggregate([
  { $group: { _id: "$customerId", totalSpent: { $sum: "$amount" } } },
  { $sort: { totalSpent: -1 } }
]);
```
#### **é«˜çº§èšåˆæ“ä½œ**
#### $facet
å…è®¸åœ¨ä¸€ä¸ªèšåˆç®¡é“ä¸­æ‰§è¡Œå¤šä¸ªä¸åŒçš„èšåˆæ“ä½œï¼Œæ¯ä¸ªå­ç®¡é“ç‹¬ç«‹æ‰§è¡Œã€‚
```
db.sales.aggregate([
  { $facet: {
      "total_sales": [{ $group: { _id: null, total: { $sum: "$amount" } } }],
      "avg_sales": [{ $group: { _id: null, avg: { $avg: "$amount" } } }]
    }
  }
]);
```
#### $bucket
ç”¨äºå°†æ•°æ®æŒ‰æŒ‡å®šçš„åˆ†æ®µèŒƒå›´è¿›è¡Œåˆ†æ¡¶æ“ä½œï¼ˆç±»ä¼¼äº SQL çš„åˆ†ç»„ï¼‰ã€‚
```
db.sales.aggregate([
  { $bucket: {
      groupBy: "$amount",
      boundaries: [0, 100, 500, 1000, 5000],
      default: "Other",
      output: { "count": { $sum: 1 } }
    }
  }
]);
```
#### $sample
ä»é›†åˆä¸­éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡çš„æ–‡æ¡£ã€‚
```
db.collection.aggregate([
  { $sample: { size: 3 } }
]);
```

#### **ğŸ“Œ å¸¸è§ MongoDB è¡¨è¾¾å¼æ“ä½œç¬¦**

#### **ğŸ”¹ 1. æ¯”è¾ƒæ“ä½œç¬¦**

| æ“ä½œç¬¦ | ä½œç”¨ | ç¤ºä¾‹ |
| --- | --- | --- |
| `$eq` | ç­‰äº | `{ $expr: { $eq: ["$price", 100] } }` |
| `$ne` | ä¸ç­‰äº | `{ $expr: { $ne: ["$status", "completed"] } }` |
| `$gt` | å¤§äº | `{ $expr: { $gt: ["$amount", 500] } }` |
| `$lt` | å°äº | `{ $expr: { $lt: ["$stock", 10] } }` |
| `$gte` | å¤§äºç­‰äº | `{ $expr: { $gte: ["$age", 18] } }` |
| `$lte` | å°äºç­‰äº | `{ $expr: { $lte: ["$discount", 0.2] } }` |

#### **ğŸ”¹ 2. é€»è¾‘æ“ä½œç¬¦**

| æ“ä½œç¬¦ | ä½œç”¨ | ç¤ºä¾‹ |
| --- | --- | --- |
| `$and` | é€»è¾‘ AND | `{ $expr: { $and: [{ $gte: ["$price", 100] }, { $lt: ["$price", 500] }] } }` |
| `$or` | é€»è¾‘ OR | `{ $expr: { $or: [{ $eq: ["$status", "completed"] }, { $eq: ["$status", "shipped"] }] } }` |
| `$not` | é€»è¾‘ NOT | `{ $expr: { $not: [{ $eq: ["$status", "pending"] }] } }` |

#### **ğŸ”¹ 3. ç®—æœ¯æ“ä½œç¬¦**

| æ“ä½œç¬¦ | ä½œç”¨ | ç¤ºä¾‹ |
| --- | --- | --- |
| `$add` | åŠ æ³• | `{ $expr: { $add: ["$price", "$tax"] } }` |
| `$subtract` | å‡æ³• | `{ $expr: { $subtract: ["$total", "$discount"] } }` |
| `$multiply` | ä¹˜æ³• | `{ $expr: { $multiply: ["$price", "$quantity"] } }` |
| `$divide` | é™¤æ³• | `{ $expr: { $divide: ["$total", "$quantity"] } }` |
| `$mod` | å–æ¨¡ | `{ $expr: { $mod: ["$stock", 2] } }` |

#### **ğŸ”¹ 4. å­—ç¬¦ä¸²æ“ä½œç¬¦**

| æ“ä½œç¬¦ | ä½œç”¨ | ç¤ºä¾‹ |
| --- | --- | --- |
| `$concat` | è¿æ¥å­—ç¬¦ä¸² | `{ $expr: { $concat: ["$firstName", " ", "$lastName"] } }` |
| `$substr` | æˆªå–å­—ç¬¦ä¸² | `{ $expr: { $substr: ["$title", 0, 5] } }` |
| `$toLower` | è½¬æ¢ä¸ºå°å†™ | `{ $expr: { $toLower: "$name" } }` |
| `$toUpper` | è½¬æ¢ä¸ºå¤§å†™ | `{ $expr: { $toUpper: "$name" } }` |

#### **ğŸ”¹ 5. æ—¥æœŸæ“ä½œç¬¦**

| æ“ä½œç¬¦ | ä½œç”¨ | ç¤ºä¾‹ |
| --- | --- | --- |
| `$dateToString` | æ ¼å¼åŒ–æ—¥æœŸ | `{ $expr: { $dateToString: { format: "%Y-%m-%d", date: "$createdAt" } } }` |
| `$year` | è·å–å¹´ä»½ | `{ $expr: { $year: "$createdAt" } }` |
| `$month` | è·å–æœˆä»½ | `{ $expr: { $month: "$createdAt" } }` |
| `$dayOfMonth` | è·å–æ—¥æœŸ | `{ $expr: { $dayOfMonth: "$createdAt" } }` |
| `$hour` | è·å–å°æ—¶ | `{ $expr: { $hour: "$createdAt" } }` |
| `$minute` | è·å–åˆ†é’Ÿ | `{ $expr: { $minute: "$createdAt" } }` |

#### **ğŸ”¹ 6. æ•°ç»„æ“ä½œç¬¦**

| æ“ä½œç¬¦ | ä½œç”¨ | ç¤ºä¾‹ |
| --- | --- | --- |
| `$size` | è·å–æ•°ç»„é•¿åº¦ | `{ $expr: { $size: "$tags" } }` |
| `$arrayElemAt` | è·å–æŒ‡å®šç´¢å¼•çš„å…ƒç´  | `{ $expr: { $arrayElemAt: ["$items", 0] } }` |
| `$in` | åˆ¤æ–­å€¼æ˜¯å¦åœ¨æ•°ç»„å†… | `{ $expr: { $in: ["shipped", "$statusHistory"] } }` |

#### **ğŸ”¹ 7. ç±»å‹è½¬æ¢æ“ä½œç¬¦**

| æ“ä½œç¬¦ | ä½œç”¨ | ç¤ºä¾‹ |
| --- | --- | --- |
| `$toInt` | è½¬æ¢ä¸ºæ•´æ•° | `{ $expr: { $toInt: "$price" } }` |
| `$toDouble` | è½¬æ¢ä¸ºåŒç²¾åº¦æµ®ç‚¹æ•° | `{ $expr: { $toDouble: "$price" } }` |
| `$toString` | è½¬æ¢ä¸ºå­—ç¬¦ä¸² | `{ $expr: { $toString: "$orderId" } }` |

* * *
#### **ğŸ“Œ `$expr` å¯ä»¥ç”¨äºå“ªäº›æ“ä½œï¼Ÿ**

`$expr` ä¸»è¦ç”¨äºæ”¯æŒ **èšåˆè¡¨è¾¾å¼** åœ¨ä»¥ä¸‹ MongoDB æ“ä½œä¸­ï¼š

| æ“ä½œ | ä½œç”¨ | ç¤ºä¾‹ |
| --- | --- | --- |
| `$match` | åœ¨ `aggregate` ç®¡é“ä¸­è¿‡æ»¤æ•°æ® | `{ $match: { $expr: { $gt: ["$price", 100] } } }` |
| `find` | åœ¨ `find` æŸ¥è¯¢ä¸­è¿‡æ»¤æ•°æ® | `db.products.find({ $expr: { $gt: ["$price", 100] } })` |
| `$lookup` | åœ¨ `pipeline` ä¸­ä½¿ç”¨å˜é‡ | `{ $lookup: { from: "orders", let: { userIdVar: "$userId" }, pipeline: [{ $match: { $expr: { $eq: ["$customerId", "$$userIdVar"] } } }] } }` |
| `$set` / `$addFields` | è®¡ç®—æ–°å­—æ®µ | `{ $set: { discountPrice: { $multiply: ["$price", 0.9] } } }` |
| `$project` | è®¡ç®—å¹¶è¿”å›æ–°å­—æ®µ | `{ $project: { total: { $add: ["$price", "$tax"] } } }` |
| `$redact` | åŸºäºé€»è¾‘æ¡ä»¶ç­›é€‰æ–‡æ¡£ | `{ $redact: { $cond: { if: { $gte: ["$sensitive", true] }, then: "$$PRUNE", else: "$$KEEP" } } }` |

#### **ğŸ“Œ ç¤ºä¾‹ï¼š$expr åœ¨ `find` å’Œ `aggregate` ä¸­çš„åº”ç”¨**

##### **ğŸ”¹ 1. `find` æŸ¥è¯¢**

`$expr` å…è®¸åœ¨ `find` é‡Œæ‰§è¡Œæ¯”è¾ƒæ“ä½œï¼š

```markdown
db.orders.find({
  $expr: { $gt: ["$amount", 50] }
});
```

ğŸ”¹ **ç­‰ä»·äºï¼š**

```markdown
SELECT * FROM orders WHERE amount > 50;
```

##### **ğŸ”¹ 2. `aggregate` æŸ¥è¯¢**

åœ¨ `aggregate` ä¸­ `$match` ç»“åˆ `$expr` ä½¿ç”¨ï¼š

```markdown
db.orders.aggregate([
  { $match: { $expr: { $gte: ["$amount", 50] } } }
]);
```

ğŸ”¹ **ç­‰ä»·äºï¼š**

```markdown
SELECT * FROM orders WHERE amount >= 50;
```

* * *

##### **ğŸ“Œ ç»“è®º**

1.  **`$expr` å¯ä»¥ç”¨äºï¼š**
    
    +   `$match`
    +   `find`
    +   `$lookup`
    +   `$set` / `$addFields`
    +   `$project`
    +   `$redact`
2.  **å¸¸è§æ“ä½œç¬¦åˆ†ç±»ï¼š**
    
    +   **æ¯”è¾ƒæ“ä½œç¬¦** (`$eq`, `$gt`, `$lt` ç­‰)
    +   **é€»è¾‘æ“ä½œç¬¦** (`$and`, `$or`, `$not`)
    +   **ç®—æœ¯æ“ä½œç¬¦** (`$add`, `$subtract`, `$multiply` ç­‰)
    +   **å­—ç¬¦ä¸²æ“ä½œç¬¦** (`$concat`, `$toLower`, `$toUpper` ç­‰)
    +   **æ—¥æœŸæ“ä½œç¬¦** (`$year`, `$month`, `$dateToString` ç­‰)
    +   **æ•°ç»„æ“ä½œç¬¦** (`$size`, `$arrayElemAt`, `$in` ç­‰)
    +   **ç±»å‹è½¬æ¢** (`$toInt`, `$toString`)

ğŸš€ **æœ€ç»ˆç»“è®ºï¼š**  
âœ… `$expr` å…è®¸ **åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨è¡¨è¾¾å¼**ï¼Œæ¯”æ™®é€š `$match` æ›´çµæ´»ï¼Œç±»ä¼¼ SQL çš„ `WHERE` æ¡ä»¶ï¼Œç‰¹åˆ«é€‚ç”¨äº `$lookup` é‡Œçš„ `pipeline` æŸ¥è¯¢ã€‚

#### èšåˆæ€§èƒ½ä¼˜åŒ–
ä½¿ç”¨ $match å’Œ $sort æ—¶çš„é¡ºåºï¼šé€šå¸¸å»ºè®®å°† $match æ”¾åœ¨ç®¡é“çš„å¼€å¤´ï¼Œä»¥å‡å°‘æ•°æ®é‡ï¼Œç„¶åå†è¿›è¡Œ $sort æ“ä½œã€‚
é¿å…è¿‡å¤šçš„ $unwindï¼šå¦‚æœæ•°ç»„å¾ˆå¤§ï¼Œå±•å¼€æ“ä½œå¯èƒ½ä¼šç”Ÿæˆå¤§é‡æ–‡æ¡£ï¼Œå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚å°½é‡é¿å…ä¸å¿…è¦çš„ $unwindã€‚
ç´¢å¼•ä¼˜åŒ–ï¼šç¡®ä¿å¯¹å¸¸ç”¨çš„æŸ¥è¯¢å­—æ®µï¼ˆä¾‹å¦‚ $match å’Œ $sort ä¸­ä½¿ç”¨çš„å­—æ®µï¼‰åˆ›å»ºç´¢å¼•ï¼Œä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ã€‚


### 11. åˆ›å»ºç´¢å¼•
ä¸ºäº†åŠ é€ŸæŸ¥è¯¢ï¼Œå¯ä»¥åˆ›å»ºç´¢å¼•ã€‚

åˆ›å»ºå•å­—æ®µç´¢å¼•ï¼š
```
db.users.createIndex({ name: 1 })
```
åˆ›å»ºå¤åˆç´¢å¼•ï¼š
```
db.users.createIndex({ name: 1, age: -1 })
```
### 12. åˆ é™¤é›†åˆ
åˆ é™¤é›†åˆåŠå…¶æ‰€æœ‰æ•°æ®ã€‚

```
db.users.drop()
```
### 13. åˆ é™¤æ•°æ®åº“
åˆ é™¤æ•´ä¸ªæ•°æ®åº“åŠå…¶æ‰€æœ‰é›†åˆã€‚
```
db.dropDatabase()
```
### 14. æŸ¥çœ‹ç´¢å¼•
æŸ¥çœ‹é›†åˆçš„æ‰€æœ‰ç´¢å¼•ã€‚
```
db.users.getIndexes()
```
### 15. åˆ é™¤ç´¢å¼•
åˆ é™¤æŸä¸ªç´¢å¼•ã€‚
```
db.users.dropIndex({ name: 1 })
```
è¿™äº›æ˜¯ MongoDB çš„ä¸€äº›å¸¸ç”¨æŒ‡ä»¤ï¼Œæ¶µç›–äº†åŸºæœ¬çš„æ•°æ®åº“æ“ä½œã€æ•°æ®æ“ä½œä»¥åŠé›†åˆå’Œç´¢å¼•ç®¡ç†ç­‰å†…å®¹ã€‚

[è·³è½¬](./mongoose.md)